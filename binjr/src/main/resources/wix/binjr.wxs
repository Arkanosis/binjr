<?xml version="1.0" encoding="utf-8"?>
<!--
  ~    Copyright 2017 Frederic Thevenet
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~         http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  ~
  -->

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <Product Id="*" Name="${project.name}"
             Language="1033"
             Version="${project.version}"
             Manufacturer="${project.organization.name}"
             UpgradeCode="e39cb23d-5950-4f94-926e-106246cbac12">
        <Package Description="${project.name}"
                 Comments="${project.description}"
                 InstallerVersion="200"
                 Compressed="yes"
                 InstallScope="perMachine"
                 Platform="x64"/>
        <Icon Id="binjr.ico" SourceFile="${project.name}.ico"/>
        <Property Id="PREVIOUSVERSIONSINSTALLED" Secure="yes"/>
        <Upgrade Id="e39cb23d-5950-4f94-926e-106246cbac12">
            <UpgradeVersion Minimum="1.0.0.0" Maximum="10.0.0.0" Property="PREVIOUSVERSIONSINSTALLED" IncludeMinimum="yes" IncludeMaximum="no"/>
        </Upgrade>
        <InstallExecuteSequence>
            <RemoveExistingProducts After="InstallInitialize"/>
        </InstallExecuteSequence>
        <Media Id="1" Cabinet="simple.cab" EmbedCab="yes"/>

        <!-- We use RemoveFolderEx to ensure application folder is fully 
             removed on uninstall. Including files created outside of MSI
             after application had been installed (e.g. on AU or user state).
             
             Hovewer, RemoveFolderEx is only available in WiX 3.6, 
             we will comment it out if we running older WiX.

             RemoveFolderEx requires that we "remember" the path for uninstall.
             Read the path value and set the APPLICATIONFOLDER property with the value.
        -->
        <Property Id="APPLICATIONFOLDER">
            <RegistrySearch Key="SOFTWARE\${project.organization.name}\${project.name}"
                            Root="HKLM" Type="raw"
                            Id="APPLICATIONFOLDER_REGSEARCH" Name="Path"/>
        </Property>
        <DirectoryRef Id="APPLICATIONFOLDER">
            <Component Id="CleanupMainApplicationFolder" Guid="*" Win64="yes">
                <RegistryValue Root="HKLM"
                               Key="SOFTWARE\${project.organization.name}\${project.name}"
                               Name="Path" Type="string" Value="[APPLICATIONFOLDER]"
                               KeyPath="yes"/>
                <!-- We need to use APPLICATIONFOLDER variable here or RemoveFolderEx
                     will not remove on "install". But only if WiX 3.6 is used. -->
                <!--     
                  <util:RemoveFolderEx On="uninstall" Property="APPLICATIONFOLDER" />
                -->
            </Component>
        </DirectoryRef>

        <?include bundle.wxi ?>


        <DirectoryRef Id="dirid7">
            <Component Id="PatchBinjrCfg" Guid="08CADF34-E417-4BA9-861B-19622EB1ACD8" Win64="yes">
                <CreateFolder/>
                <!--<Condition>!Runtime = 2</Condition>-->
                <IniFile Id="ModifyCfg"
                         Action="removeLine"
                         Section="Application"
                         Name="binjr.cfg"
                         Key="app.runtime"/>
            </Component>
        </DirectoryRef>

        <Feature Id="binjrRoot"
                 Level="1"
                 ConfigurableDirectory="APPLICATIONFOLDER"
                 Title="binjr"
                 TypicalDefault="install"
                 Absent="disallow"
                 AllowAdvertise="no"
                 Description="The main application files for binjr."
                 InstallDefault="local"
                 Display="expand">
            <ComponentRef Id="comp0"/>
            <ComponentRef Id="comp1"/>
            <ComponentRef Id="comp2"/>
            <ComponentRef Id="CleanupMainApplicationFolder"/>
            <Feature Id="Runtime"
                     Level="1"
                     Title="Runtime"
                     TypicalDefault="install"
                     Absent="allow"
                     AllowAdvertise="no"
                     Description="A private copy of the Java Runtime Environment, used exclusively by binjr."
                     InstallDefault="local"
                     Display="expand">
                <ComponentRef Id="comp3"/>
                <ComponentRef Id="comp4"/>
                <ComponentRef Id="comp5"/>
                <ComponentRef Id="comp6"/>
                <ComponentRef Id="comp7"/>
                <ComponentRef Id="comp8"/>
                <ComponentRef Id="comp9"/>
                <ComponentRef Id="comp10"/>
                <ComponentRef Id="comp11"/>
                <ComponentRef Id="comp12"/>
                <ComponentRef Id="comp13"/>
                <ComponentRef Id="comp14"/>
                <ComponentRef Id="comp15"/>
                <ComponentRef Id="comp16"/>
                <ComponentRef Id="comp17"/>
            </Feature>
            <ComponentRef Id="PatchBinjrCfg"/>
        </Feature>

        <WixVariable Id="WixUIBannerBmp" Value="..\images\Install_Banner.jpg"/>
        <WixVariable Id="WixUIDialogBmp" Value="..\images\Install_Splash.jpg"/>

        <Property Id="WIXUI_INSTALLDIR" Value="APPLICATIONFOLDER"/>
        <!--<UIRef Id="WixUI_FeatureTree"/>-->
        <UI Id="WixUI_binjr">
            <TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8"/>
            <TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12"/>
            <TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes"/>
            <Property Id="DefaultUIFont" Value="WixUI_Font_Normal"/>
            <!--<Property Id="WixUI_Mode" Value="FeatureTree" />-->
            <Property Id="WixUI_Mode" Value="InstallDir"/>
            <DialogRef Id="BrowseDlg"/>
            <DialogRef Id="DiskCostDlg"/>
            <DialogRef Id="ErrorDlg"/>
            <DialogRef Id="FatalError"/>
            <DialogRef Id="FilesInUse"/>
            <DialogRef Id="MsiRMFilesInUse"/>
            <DialogRef Id="PrepareDlg"/>
            <DialogRef Id="ProgressDlg"/>
            <DialogRef Id="ResumeDlg"/>
            <DialogRef Id="UserExit"/>

            <Publish Dialog="BrowseDlg" Control="OK" Event="DoAction" Value="WixUIValidatePath" Order="3">1</Publish>
            <Publish Dialog="BrowseDlg" Control="OK" Event="SpawnDialog" Value="InvalidDirDlg" Order="4"><![CDATA[WIXUI_INSTALLDIR_VALID<>"1"]]></Publish>

            <Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="999">1</Publish>
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="SetTargetPath" Value="[WIXUI_INSTALLDIR]" Order="1">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="DoAction" Value="WixUIValidatePath" Order="2">NOT WIXUI_DONTVALIDATEPATH</Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="SpawnDialog" Value="InvalidDirDlg" Order="3"><![CDATA[NOT WIXUI_DONTVALIDATEPATH AND WIXUI_INSTALLDIR_VALID<>"1"]]></Publish>

            <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Property="_BrowseProperty" Value="[WIXUI_INSTALLDIR]" Order="1">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Event="SpawnDialog" Value="BrowseDlg" Order="2">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>

            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg" Order="1">NOT Installed OR WixUI_InstallMode = "Change"</Publish>
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg" Order="2">Installed</Publish>
            <Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
            <Publish Dialog="MaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg">1</Publish>
        </UI>
        <UIRef Id="WixUI_Common"/>


        <Icon Id="DesktopIcon.exe" SourceFile="binjr.ico"/>
        <Icon Id="StartMenuIcon.exe" SourceFile="binjr.ico"/>

    </Product>
</Wix>
